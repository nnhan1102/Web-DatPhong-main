<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Đặt Phòng - Opulent Hotel</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      /* Styles từ room.html - bạn có thể tách ra file CSS riêng */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: #f8f9fa;
        color: #333;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        text-align: center;
        margin-bottom: 40px;
        padding: 40px 0;
        background: linear-gradient(
          rgba(0, 174, 239, 0.9),
          rgba(0, 174, 239, 0.8)
        );
        color: white;
        border-radius: 12px;
      }

      .header h1 {
        font-size: 36px;
        margin-bottom: 10px;
      }

      .booking-container {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 30px;
      }

      .booking-form {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
      }

      .booking-summary {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        position: sticky;
        top: 20px;
      }

      .form-group {
        margin-bottom: 25px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #555;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 15px;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      .btn {
        padding: 15px 30px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        font-size: 16px;
        transition: all 0.3s;
        width: 100%;
      }

      .btn-primary {
        background: #00aeef;
        color: white;
      }

      .btn-primary:hover {
        background: #008ac0;
      }

      .room-info {
        display: flex;
        gap: 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .room-info img {
        width: 150px;
        height: 100px;
        object-fit: cover;
        border-radius: 8px;
      }

      .price-details {
        border-top: 1px solid #eee;
        border-bottom: 1px solid #eee;
        padding: 20px 0;
        margin: 20px 0;
      }

      .price-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
      }

      .total-price {
        display: flex;
        justify-content: space-between;
        font-size: 20px;
        font-weight: bold;
        color: #00aeef;
        margin-top: 20px;
      }

      @media (max-width: 768px) {
        .booking-container {
          grid-template-columns: 1fr;
        }

        .form-row {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1><i class="fas fa-calendar-check"></i> Đặt Phòng</h1>
        <p>Hoàn tất thông tin để xác nhận đặt phòng của bạn</p>
      </div>

      <div class="booking-container">
        <div class="booking-form">
          <h2 style="margin-bottom: 30px; color: #2c3e50">
            Thông tin đặt phòng
          </h2>

          <div class="form-group">
            <label for="fullName"
              ><i class="fas fa-user"></i> Họ và tên *</label
            >
            <input type="text" id="fullName" required />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="email"><i class="fas fa-envelope"></i> Email *</label>
              <input type="email" id="email" required />
            </div>
            <div class="form-group">
              <label for="phone"
                ><i class="fas fa-phone"></i> Số điện thoại *</label
              >
              <input type="tel" id="phone" required />
            </div>
          </div>

          <div class="form-group">
            <label for="checkinDate"
              ><i class="fas fa-calendar-alt"></i> Ngày nhận phòng *</label
            >
            <input type="date" id="checkinDate" required />
          </div>

          <div class="form-group">
            <label for="checkoutDate"
              ><i class="fas fa-calendar-alt"></i> Ngày trả phòng *</label
            >
            <input type="date" id="checkoutDate" required />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="adults"
                ><i class="fas fa-user"></i> Người lớn *</label
              >
              <select id="adults" required>
                <option value="1">1 người</option>
                <option value="2" selected>2 người</option>
                <option value="3">3 người</option>
                <option value="4">4 người</option>
              </select>
            </div>
            <div class="form-group">
              <label for="children"><i class="fas fa-child"></i> Trẻ em</label>
              <select id="children">
                <option value="0" selected>0 trẻ</option>
                <option value="1">1 trẻ</option>
                <option value="2">2 trẻ</option>
                <option value="3">3 trẻ</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="specialRequests"
              ><i class="fas fa-comment"></i> Yêu cầu đặc biệt</label
            >
            <textarea
              id="specialRequests"
              rows="4"
              placeholder="Ví dụ: Phòng không hút thuốc, giường đôi..."
            ></textarea>
          </div>

          <div class="form-group">
            <label for="paymentMethod"
              ><i class="fas fa-credit-card"></i> Phương thức thanh toán
              *</label
            >
            <select id="paymentMethod" required>
              <option value="">Chọn phương thức thanh toán</option>
              <option value="cash">Thanh toán tại khách sạn</option>
              <option value="credit">Thẻ tín dụng</option>
              <option value="banking">Chuyển khoản ngân hàng</option>
            </select>
          </div>

          <button class="btn btn-primary" id="confirmBooking">
            <i class="fas fa-check-circle"></i>
            Xác nhận đặt phòng
          </button>
        </div>

        <div class="booking-summary">
          <h2 style="margin-bottom: 20px; color: #2c3e50">Tóm tắt đơn đặt</h2>

          <div id="roomSummary">
            <!-- Room info will be loaded here -->
          </div>

          <div class="price-details">
            <div class="price-row">
              <span>Giá phòng/đêm</span>
              <span id="pricePerNight">0 VND</span>
            </div>
            <div class="price-row">
              <span>Số đêm</span>
              <span id="nightsCount">0 đêm</span>
            </div>
            <div class="price-row">
              <span>Phí dịch vụ</span>
              <span>Miễn phí</span>
            </div>
            <div class="price-row">
              <span>Thuế VAT</span>
              <span>10%</span>
            </div>
          </div>

          <div class="total-price">
            <span>Tổng cộng:</span>
            <span id="totalPrice">0 VND</span>
          </div>

          <div
            style="
              margin-top: 20px;
              padding: 15px;
              background: #f0f9ff;
              border-radius: 8px;
              color: #666;
              font-size: 14px;
            "
          >
            <p>
              <i class="fas fa-info-circle"></i>
              <strong>Chính sách hủy phòng:</strong>
            </p>
            <ul style="margin-left: 20px; margin-top: 10px">
              <li>Hủy miễn phí trước 24 giờ</li>
              <li>Hủy trong vòng 24 giờ: phí 30%</li>
              <li>Check-in sau 18:00 vui lòng thông báo</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Load selected room from session storage
      const selectedRoom = JSON.parse(sessionStorage.getItem("selected_room"));

      if (!selectedRoom) {
        alert("Vui lòng chọn phòng trước khi đặt");
        window.location.href = "room.html";
        return;
      }

      // Load user data if logged in
      const userData = localStorage.getItem("opulent_user");
      if (userData) {
        try {
          const user = JSON.parse(userData);
          if (user.isLoggedIn) {
            document.getElementById("fullName").value = user.full_name || "";
            document.getElementById("email").value = user.email || "";
            document.getElementById("phone").value = user.phone || "";
          } else {
            // User not logged in, redirect to login
            alert("Vui lòng đăng nhập để đặt phòng");
            window.location.href = "../login/login.html";
            return;
          }
        } catch (error) {
          console.error("Error loading user data:", error);
          alert("Vui lòng đăng nhập để đặt phòng");
          window.location.href = "../login/login.html";
          return;
        }
      } else {
        // No user data, redirect to login
        alert("Vui lòng đăng nhập để đặt phòng");
        window.location.href = "../login/login.html";
        return;
      }

      // Display room summary
      const roomSummary = document.getElementById("roomSummary");
      roomSummary.innerHTML = `
            <div class="room-info">
                <img src="${
                  selectedRoom.image_url ||
                  "https://via.placeholder.com/150x100/00aeef/ffffff?text=Phòng"
                }" 
                     alt="${selectedRoom.room_type}"
                     onerror="this.src='https://via.placeholder.com/150x100/00aeef/ffffff?text=Phòng'">
                <div>
                    <h3 style="color: #2c3e50; margin-bottom: 5px;">${
                      selectedRoom.room_type || selectedRoom.type_name
                    }</h3>
                    <p style="color: #666; margin-bottom: 5px;">Phòng ${
                      selectedRoom.room_number
                    }</p>
                    <p style="color: #666; margin-bottom: 5px;">Tối đa ${
                      selectedRoom.capacity
                    } người</p>
                </div>
            </div>
        `;

      // Set default dates
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      const dayAfter = new Date();
      dayAfter.setDate(dayAfter.getDate() + 2);

      document.getElementById("checkinDate").value = tomorrow
        .toISOString()
        .split("T")[0];
      document.getElementById("checkoutDate").value = dayAfter
        .toISOString()
        .split("T")[0];

      // Set date restrictions
      setupDatePickers();

      // Calculate initial price
      calculateTotalPrice();

      // Add event listeners for date changes
      document
        .getElementById("checkinDate")
        .addEventListener("change", calculateTotalPrice);
      document
        .getElementById("checkoutDate")
        .addEventListener("change", calculateTotalPrice);
      document
        .getElementById("adults")
        .addEventListener("change", calculateTotalPrice);
      document
        .getElementById("children")
        .addEventListener("change", calculateTotalPrice);

      // Confirm booking
      document
        .getElementById("confirmBooking")
        .addEventListener("click", confirmBooking);
    });

    function setupDatePickers() {
      const checkin = document.getElementById("checkinDate");
      const checkout = document.getElementById("checkoutDate");

      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      checkin.min = tomorrow.toISOString().split("T")[0];

      checkin.addEventListener("change", function () {
        const nextDay = new Date(this.value);
        nextDay.setDate(nextDay.getDate() + 1);
        checkout.min = nextDay.toISOString().split("T")[0];
        if (checkout.value < checkout.min) {
          checkout.value = checkout.min;
        }
      });
    }

    function calculateTotalPrice() {
      const checkin = new Date(document.getElementById("checkinDate").value);
      const checkout = new Date(document.getElementById("checkoutDate").value);

      if (!checkin || !checkout || checkout <= checkin) return;

      const nights = Math.ceil((checkout - checkin) / (1000 * 60 * 60 * 24));
      const selectedRoom = JSON.parse(sessionStorage.getItem("selected_room"));
      const pricePerNight =
        selectedRoom.price_per_night || selectedRoom.base_price || 0;
      const total = pricePerNight * nights;
      const vat = total * 0.1;
      const finalTotal = total + vat;

      document.getElementById("pricePerNight").textContent =
        formatCurrency(pricePerNight);
      document.getElementById("nightsCount").textContent = nights + " đêm";
      document.getElementById("totalPrice").textContent =
        formatCurrency(finalTotal);

      return finalTotal;
    }

    async function confirmBooking() {
      try {
        // Validate form
        const requiredFields = [
          "fullName",
          "email",
          "phone",
          "checkinDate",
          "checkoutDate",
          "paymentMethod",
        ];

        let isValid = true;
        let errorMessage = "";

        requiredFields.forEach((fieldId) => {
          const field = document.getElementById(fieldId);
          if (!field.value.trim()) {
            field.style.borderColor = "#dc3545";
            isValid = false;
            errorMessage += `${field.previousElementSibling.textContent} không được để trống\n`;
          } else {
            field.style.borderColor = "#ddd";
          }
        });

        if (!isValid) {
          alert("Vui lòng điền đầy đủ thông tin bắt buộc:\n" + errorMessage);
          return;
        }

        // Validate email
        const email = document.getElementById("email").value;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          alert("Email không hợp lệ");
          document.getElementById("email").style.borderColor = "#dc3545";
          return;
        }

        // Validate phone number
        const phone = document.getElementById("phone").value;
        const phoneRegex = /^[0-9]{10,11}$/;
        if (!phoneRegex.test(phone)) {
          alert("Số điện thoại không hợp lệ (10-11 số)");
          document.getElementById("phone").style.borderColor = "#dc3545";
          return;
        }

        // Check dates
        const checkin = new Date(document.getElementById("checkinDate").value);
        const checkout = new Date(
          document.getElementById("checkoutDate").value
        );
        if (checkin >= checkout) {
          alert("Ngày check-out phải sau ngày check-in");
          document.getElementById("checkoutDate").style.borderColor = "#dc3545";
          return;
        }

        // Get user data
        const userData = localStorage.getItem("opulent_user");
        if (!userData) {
          alert("Vui lòng đăng nhập để đặt phòng");
          window.location.href = "../auth/login.html"; // Sửa đường dẫn login
          return;
        }

        const user = JSON.parse(userData);
        if (!user.isLoggedIn) {
          alert("Vui lòng đăng nhập để đặt phòng");
          window.location.href = "../auth/login.html"; // Sửa đường dẫn login
          return;
        }

        // Get selected room
        const selectedRoom = JSON.parse(
          sessionStorage.getItem("selected_room")
        );
        if (!selectedRoom) {
          alert("Không tìm thấy thông tin phòng. Vui lòng chọn lại phòng.");
          window.location.href = "room.html";
          return;
        }

        // Calculate total price
        const totalPrice = calculateTotalPrice();

        // Prepare booking data
        const bookingData = {
          room_id: selectedRoom.id,
          check_in: document.getElementById("checkinDate").value,
          check_out: document.getElementById("checkoutDate").value,
          num_guests:
            parseInt(document.getElementById("adults").value) +
            parseInt(document.getElementById("children").value),
          total_price: totalPrice,
          special_requests: document.getElementById("specialRequests").value,
          payment_method: document.getElementById("paymentMethod").value,
          customer_name: document.getElementById("fullName").value,
          customer_email: document.getElementById("email").value,
          customer_phone: document.getElementById("phone").value,
        };

        console.log("Sending booking data:", bookingData);

        // HÀM TẠO TOKEN ĐÚNG CÁCH
        function createToken(userObj) {
          const jsonStr = JSON.stringify(userObj);
          return btoa(
            encodeURIComponent(jsonStr).replace(
              /%([0-9A-F]{2})/g,
              function (match, p1) {
                return String.fromCharCode("0x" + p1);
              }
            )
          );
        }

        const token = createToken(user);
        console.log("Token created:", token.substring(0, 50) + "...");

        // GỌI API - SỬA ĐƯỜNG DẪN CHÍNH XÁC
        const API_URL =
          "../backend/api/controllers/BookingController.php?action=create";
        console.log("Calling API:", API_URL);

        const response = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
          body: JSON.stringify(bookingData),
        });

        console.log("Response status:", response.status);

        // Xử lý response
        const responseText = await response.text();
        console.log("Raw response:", responseText);

        // Kiểm tra nếu là HTML error (lỗi PHP)
        if (
          responseText.includes("<!DOCTYPE") ||
          responseText.includes("<html") ||
          responseText.includes("Fatal error") ||
          responseText.includes("Parse error")
        ) {
          console.error("PHP Error detected:", responseText.substring(0, 500));

          // Tạo fallback - thử gọi quick-fix.php nếu file chính bị lỗi
          alert("Hệ thống đang bảo trì. Đang thử phương án dự phòng...");

          // Thử gọi quick-fix.php
          const fallbackResponse = await fetch(
            "../../backend/api/controllers/quick-fix.php?action=create",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify(bookingData),
            }
          );

          const fallbackText = await fallbackResponse.text();
          console.log("Fallback response:", fallbackText);

          try {
            const fallbackResult = JSON.parse(fallbackText);

            if (fallbackResult.success) {
              // Success với fallback
              sessionStorage.removeItem("selected_room");
              sessionStorage.setItem(
                "booking_confirmation",
                JSON.stringify({
                  booking_code: fallbackResult.data.booking_code,
                  room: selectedRoom,
                  booking: bookingData,
                  booking_id: fallbackResult.data.booking_id,
                  room_number: fallbackResult.data.room_number,
                  room_type: fallbackResult.data.room_type,
                })
              );
              window.location.href = "booking-confirmation.html";
              return;
            } else {
              throw new Error(
                "Fallback also failed: " + fallbackResult.message
              );
            }
          } catch (fallbackError) {
            throw new Error(
              "Main API error and fallback failed. Check server logs.\nOriginal error: " +
                responseText.substring(0, 200)
            );
          }
        }

        // Parse JSON response
        let result;
        try {
          result = JSON.parse(responseText);
        } catch (e) {
          console.error(
            "JSON parse error:",
            e,
            "Response:",
            responseText.substring(0, 200)
          );
          throw new Error(
            "Server returned invalid JSON. Check PHP configuration."
          );
        }

        console.log("Response data:", result);

        if (result.success) {
          // Success - redirect to confirmation
          sessionStorage.removeItem("selected_room");
          sessionStorage.setItem(
            "booking_confirmation",
            JSON.stringify({
              booking_code: result.data.booking_code,
              room: selectedRoom,
              booking: bookingData,
              booking_id: result.data.booking_id,
              room_number: result.data.room_number || selectedRoom.room_number,
              room_type: result.data.room_type || selectedRoom.room_type,
              total_price: result.data.total_price || totalPrice,
              check_in: result.data.check_in || bookingData.check_in,
              check_out: result.data.check_out || bookingData.check_out,
            })
          );

          // Redirect to confirmation page
          window.location.href = "booking-confirmation.html";
        } else {
          alert("Lỗi khi đặt phòng: " + result.message);
          console.error("Booking error details:", result);

          // Hiển thị thêm thông tin debug nếu có
          if (result.debug_info) {
            console.error("Debug info:", result.debug_info);
          }
        }
      } catch (error) {
        console.error("Error booking room:", error);
        alert(
          "Lỗi kết nối đến server. Vui lòng thử lại sau.\n\nChi tiết: " +
            error.message +
            "\n\nVui lòng kiểm tra:\n" +
            "1. Server có đang chạy không\n" +
            "2. Kết nối internet\n" +
            "3. File BookingController.php có lỗi PHP không"
        );
      }
    }
    function formatCurrency(amount) {
      return new Intl.NumberFormat("vi-VN", {
        style: "currency",
        currency: "VND",
        minimumFractionDigits: 0,
      }).format(amount || 0);
    }
  </script>
</html>
