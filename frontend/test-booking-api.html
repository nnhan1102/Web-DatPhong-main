<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Booking API</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .test-section {
        margin-bottom: 30px;
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      .result {
        margin-top: 10px;
        padding: 10px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 3px;
        white-space: pre-wrap;
      }
      .success {
        color: green;
      }
      .error {
        color: red;
      }
      .url {
        background: #e9ecef;
        padding: 5px;
        border-radius: 3px;
        font-family: monospace;
      }
    </style>
  </head>
  <body>
    <h1>Test Booking API</h1>

    <div class="test-section">
      <h2>1. Test K·∫øt n·ªëi API</h2>
      <p>URL API: <span class="url" id="apiUrl"></span></p>
      <button onclick="testConnection()">Test K·∫øt n·ªëi</button>
      <div class="result" id="connectionResult"></div>
    </div>

    <div class="test-section">
      <h2>2. Test Authentication</h2>
      <div>
        <label>User JSON (t·ª´ localStorage):</label><br />
        <textarea
          id="userJson"
          rows="6"
          style="width: 100%; font-family: monospace; margin: 10px 0"
        >
{
    "id": 1,
    "full_name": "Nguy·ªÖn VƒÉn A",
    "email": "test@example.com",
    "phone": "0123456789",
    "isLoggedIn": true,
    "user_type": "customer"
}
            </textarea
        >
      </div>
      <button onclick="testAuthentication()">Test Authentication Token</button>
      <div class="result" id="authResult"></div>
    </div>

    <div class="test-section">
      <h2>3. Test G·ª≠i Booking Request</h2>
      <button onclick="testBookingRequest()">Test Booking Request</button>
      <div class="result" id="bookingResult"></div>
    </div>

    <div class="test-section">
      <h2>4. Ki·ªÉm tra ƒë∆∞·ªùng d·∫´n file PHP</h2>
      <button onclick="checkPhpFile()">
        Ki·ªÉm tra file BookingController.php
      </button>
      <div class="result" id="fileCheckResult"></div>
    </div>

    <script>
      // ƒê∆∞·ªùng d·∫´n API - c·∫≠p nh·∫≠t ƒë√∫ng v·ªõi c·∫•u tr√∫c th∆∞ m·ª•c c·ªßa b·∫°n
      const API_URL = "../../backend/api/controllers/BookingController.php";
      document.getElementById("apiUrl").textContent = API_URL;

      // H√†m safe btoa
      function safeBtoa(str) {
        return btoa(
          encodeURIComponent(str).replace(
            /%([0-9A-F]{2})/g,
            function (match, p1) {
              return String.fromCharCode("0x" + p1);
            }
          )
        );
      }

      // 1. Test k·∫øt n·ªëi c∆° b·∫£n
      async function testConnection() {
        const resultEl = document.getElementById("connectionResult");
        resultEl.innerHTML = "ƒêang ki·ªÉm tra...";

        try {
          const response = await fetch(API_URL);
          const contentType = response.headers.get("content-type");
          const text = await response.text();

          let result = `Status: ${response.status} ${response.statusText}\n`;
          result += `Content-Type: ${contentType}\n`;
          result += `Response (first 500 chars):\n${text.substring(0, 500)}...`;

          if (contentType && contentType.includes("application/json")) {
            resultEl.className = "result success";
          } else if (text.includes("<!DOCTYPE") || text.includes("<html")) {
            resultEl.className = "result error";
            result += "\n\n‚ö†Ô∏è WARNING: Server tr·∫£ v·ªÅ HTML thay v√¨ JSON!\n";
            result += "ƒêi·ªÅu n√†y c√≥ nghƒ©a l√†:\n";
            result += "1. ƒê∆∞·ªùng d·∫´n API sai\n";
            result += "2. PHP c√≥ l·ªói syntax\n";
            result += "3. File kh√¥ng t·ªìn t·∫°i\n";
          } else {
            resultEl.className = "result";
          }

          resultEl.textContent = result;
        } catch (error) {
          resultEl.className = "result error";
          resultEl.textContent = `L·ªói: ${error.message}\n\nC√≥ th·ªÉ:\n1. Server kh√¥ng ch·∫°y\n2. ƒê∆∞·ªùng d·∫´n sai\n3. CORS issue`;
        }
      }

      // 2. Test authentication token
      function testAuthentication() {
        const userJson = document.getElementById("userJson").value;
        const resultEl = document.getElementById("authResult");

        try {
          const user = JSON.parse(userJson);
          const token = safeBtoa(JSON.stringify(user));

          // Decode ƒë·ªÉ ki·ªÉm tra
          const decoded = atob(token);
          const decodedJson = decodeURIComponent(
            decoded.replace(/(.)/g, function (m, c) {
              return "%" + c.charCodeAt(0).toString(16).padStart(2, "0");
            })
          );

          resultEl.className = "result success";
          resultEl.innerHTML = `
<b>Token t·∫°o th√†nh c√¥ng!</b>
Token (base64): ${token.substring(0, 50)}...
ƒê·ªô d√†i: ${token.length} k√Ω t·ª±

<b>Decoded token:</b>
${decodedJson}
                `;
        } catch (error) {
          resultEl.className = "result error";
          resultEl.textContent = `L·ªói t·∫°o token: ${error.message}`;
        }
      }

      // 3. Test g·ª≠i booking request
      async function testBookingRequest() {
        const resultEl = document.getElementById("bookingResult");
        resultEl.innerHTML = "ƒêang g·ª≠i request...";

        try {
          // T·∫°o user test
          const user = {
            id: 1,
            full_name: "Nguy·ªÖn VƒÉn Test",
            email: "test@example.com",
            phone: "0123456789",
            isLoggedIn: true,
            user_type: "customer",
          };

          const token = safeBtoa(JSON.stringify(user));

          // T·∫°o booking data test
          const bookingData = {
            room_id: 1,
            check_in: "2024-12-26",
            check_out: "2024-12-28",
            num_guests: 2,
            total_price: 2000000,
            payment_method: "cash",
            special_requests: "Test booking",
            customer_name: "Nguy·ªÖn VƒÉn Test",
            customer_email: "test@example.com",
            customer_phone: "0123456789",
          };

          console.log("Sending request to:", API_URL + "?action=create");
          console.log("Token:", token.substring(0, 50) + "...");
          console.log("Data:", bookingData);

          const response = await fetch(API_URL + "?action=create", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(bookingData),
          });

          const responseText = await response.text();
          let result = `Status: ${response.status}\n`;
          result += `Content-Type: ${response.headers.get("content-type")}\n\n`;

          // Ki·ªÉm tra n·∫øu l√† HTML
          if (
            responseText.includes("<!DOCTYPE") ||
            responseText.includes("<html")
          ) {
            resultEl.className = "result error";
            result += `‚ö†Ô∏è SERVER TR·∫¢ V·ªÄ HTML:\n\n`;
            result += responseText.substring(0, 1000);

            // T√¨m l·ªói PHP trong response
            if (
              responseText.includes("Parse error") ||
              responseText.includes("Fatal error")
            ) {
              result += "\n\nüî¥ PH√ÅT HI·ªÜN L·ªñI PHP!";
            }
          } else {
            // Th·ª≠ parse JSON
            try {
              const jsonData = JSON.parse(responseText);
              resultEl.className = "result success";
              result += `‚úÖ JSON Response:\n${JSON.stringify(
                jsonData,
                null,
                2
              )}`;
            } catch (e) {
              resultEl.className = "result error";
              result += `‚ùå Kh√¥ng parse ƒë∆∞·ª£c JSON: ${e.message}\n`;
              result += `Response text:\n${responseText}`;
            }
          }

          resultEl.textContent = result;
        } catch (error) {
          resultEl.className = "result error";
          resultEl.textContent = `L·ªói: ${error.message}\n\nStack: ${error.stack}`;
        }
      }

      // 4. Ki·ªÉm tra file PHP
      async function checkPhpFile() {
        const resultEl = document.getElementById("fileCheckResult");
        resultEl.innerHTML = "ƒêang ki·ªÉm tra...";

        try {
          // Ki·ªÉm tra file t·ªìn t·∫°i
          const response = await fetch(API_URL);
          const text = await response.text();

          let result = `Status: ${response.status}\n`;

          if (response.status === 404) {
            resultEl.className = "result error";
            result += "‚ùå File kh√¥ng t·ªìn t·∫°i (404)\n";
            result += "Ki·ªÉm tra ƒë∆∞·ªùng d·∫´n: " + API_URL;
          } else if (
            text.includes("Parse error") ||
            text.includes("Fatal error")
          ) {
            resultEl.className = "result error";
            result += "‚ùå File PHP c√≥ l·ªói syntax\n\n";
            result += text.substring(0, 500);
          } else if (text.includes("BookingController")) {
            resultEl.className = "result success";
            result += "‚úÖ File PHP t·ªìn t·∫°i v√† ch·∫°y ƒë∆∞·ª£c\n";

            // Ki·ªÉm tra n·∫øu hi·ªÉn th·ªã code PHP
            if (
              text.includes("<?php") &&
              text.includes("class BookingController")
            ) {
              result += "‚ö†Ô∏è C·∫£nh b√°o: C√≥ th·ªÉ hi·ªÉn th·ªã m√£ ngu·ªìn PHP\n";
              result +=
                "Ki·ªÉm tra c·∫•u h√¨nh PHP (short_open_tag, display_errors)";
            }
          } else {
            resultEl.className = "result";
            result += "Response:\n" + text.substring(0, 300);
          }

          resultEl.textContent = result;
        } catch (error) {
          resultEl.className = "result error";
          resultEl.textContent = `L·ªói: ${error.message}`;
        }
      }

      // Ch·∫°y test k·∫øt n·ªëi khi load trang
      window.onload = testConnection;
    </script>
  </body>
</html>
