<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel - Opulent</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="../assets/css/admin.css" />
  </head>
  <body>
    <div class="admin-container">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="sidebar-header">
          <div class="logo">
            <i class="fas fa-plane-departure"></i>
            <h2>Opulent</h2>
          </div>
        </div>

        <nav class="sidebar-menu">
          <ul>
            <li class="active" data-section="dashboard">
              <a href="#">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
              </a>
            </li>
            <li data-section="tours">
              <a href="#">
                <i class="fas fa-map-marked-alt"></i>
                <span>Quản lý Tour</span>
              </a>
            </li>
            <li data-section="bookings">
              <a href="#">
                <i class="fas fa-calendar-check"></i>
                <span>Quản lý Đặt Tour</span>
              </a>
            </li>
            <li data-section="customers">
              <a href="#">
                <i class="fas fa-users"></i>
                <span>Quản lý Khách hàng</span>
              </a>
            </li>
            <li data-section="hotels">
              <a href="#">
                <i class="fas fa-hotel"></i>
                <span>Quản lý Đặt Phòng</span>
              </a>
            </li>
            <li data-section="categories">
              <a href="#">
                <i class="fas fa-tags"></i>
                <span>Danh mục</span>
              </a>
            </li>
            <li data-section="reports">
              <a href="#">
                <i class="fas fa-chart-bar"></i>
                <span>Báo cáo</span>
              </a>
            </li>
          </ul>
        </nav>

        <div class="sidebar-footer">
          <div class="user-profile">
            <div class="avatar">
              <i class="fas fa-user-circle"></i>
            </div>
            <div class="user-info">
              <h4>Admin User</h4>
              <p>Quản trị viên</p>
            </div>
          </div>
          <button class="logout-btn">
            <i class="fas fa-sign-out-alt"></i> Đăng xuất
          </button>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Header -->
        <header class="main-header">
          <div class="header-left">
            <h1 id="page-title">Dashboard</h1>
            <p id="page-subtitle">Tổng quan hệ thống</p>
          </div>
          <div class="header-right">
            <div class="date-time">
              <span id="current-date"></span>
              <span id="current-time"></span>
            </div>
            <div class="notification">
              <i class="fas fa-bell"></i>
              <span class="badge" id="notification-count">3</span>
            </div>
          </div>
        </header>

        <!-- Dashboard Section -->
        <section class="content-section active" id="dashboard-section">
          <div class="stats-cards">
            <div class="stat-card">
              <div class="stat-icon" style="background-color: #4e73df">
                <i class="fas fa-map-marked-alt"></i>
              </div>
              <div class="stat-info">
                <h3 id="total-tours">0</h3>
                <p>Tổng số tour</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon" style="background-color: #1cc88a">
                <i class="fas fa-calendar-check"></i>
              </div>
              <div class="stat-info">
                <h3 id="total-bookings">0</h3>
                <p>Đặt tour hôm nay</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon" style="background-color: #f6c23e">
                <i class="fas fa-users"></i>
              </div>
              <div class="stat-info">
                <h3 id="total-customers">0</h3>
                <p>Tổng khách hàng</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon" style="background-color: #e74a3b">
                <i class="fas fa-money-bill-wave"></i>
              </div>
              <div class="stat-info">
                <h3 id="total-revenue">0đ</h3>
                <p>Doanh thu tháng</p>
              </div>
            </div>
          </div>

          <div class="charts-container">
            <div class="chart-card">
              <h3>Doanh thu theo tháng</h3>
              <canvas id="revenueChart"></canvas>
            </div>
            <div class="chart-card">
              <h3>Tour được đặt nhiều nhất</h3>
              <canvas id="popularToursChart"></canvas>
            </div>
          </div>

          <div class="recent-activity">
            <h3>Hoạt động gần đây</h3>
            <div class="activity-list" id="recent-activities">
              <!-- Activities will be loaded here -->
            </div>
          </div>
        </section>

        <!-- Tours Management Section -->
        <section class="content-section" id="tours-section">
          <div class="section-header">
            <h2>Quản lý Tour</h2>
            <button class="btn btn-primary" id="add-tour-btn">
              <i class="fas fa-plus"></i> Thêm tour mới
            </button>
          </div>

          <div class="filters">
            <div class="filter-group">
              <input
                type="text"
                id="tour-search"
                placeholder="Tìm kiếm tour..."
              />
            </div>
            <div class="filter-group">
              <select id="tour-status-filter">
                <option value="">Tất cả trạng thái</option>
                <option value="active">Đang hoạt động</option>
                <option value="inactive">Ngừng hoạt động</option>
                <option value="sold_out">Hết chỗ</option>
              </select>
            </div>
            <button class="btn btn-secondary" id="apply-filters">Lọc</button>
          </div>

          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Hình ảnh</th>
                  <th>Tên tour</th>
                  <th>Điểm đến</th>
                  <th>Giá</th>
                  <th>Giảm giá</th>
                  <th>Số chỗ</th>
                  <th>Trạng thái</th>
                  <th>Ngày tạo</th>
                  <th>Thao tác</th>
                </tr>
              </thead>
              <tbody id="tours-table-body">
                <tr>
                  <td colspan="10" class="loading-row">Đang tải dữ liệu...</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="pagination" id="tours-pagination">
            <!-- Pagination will be loaded here -->
          </div>
        </section>

        <!-- Bookings Management Section -->
        <section class="content-section" id="bookings-section">
          <div class="section-header">
            <h2>Quản lý Đặt Tour</h2>
            <div class="header-actions">
              <button class="btn btn-secondary" id="export-bookings">
                <i class="fas fa-download"></i> Xuất Excel
              </button>
            </div>
          </div>

          <div class="filters">
            <div class="filter-group">
              <input
                type="text"
                id="booking-search"
                placeholder="Mã đặt tour..."
              />
            </div>
            <div class="filter-group">
              <select id="booking-status-filter">
                <option value="">Tất cả trạng thái</option>
                <option value="pending">Chờ xác nhận</option>
                <option value="confirmed">Đã xác nhận</option>
                <option value="cancelled">Đã hủy</option>
                <option value="completed">Hoàn thành</option>
              </select>
            </div>
            <div class="filter-group">
              <input type="date" id="booking-date-filter" />
            </div>
            <button class="btn btn-secondary" id="apply-booking-filters">
              Lọc
            </button>
          </div>

          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Mã đặt</th>
                  <th>Tour</th>
                  <th>Khách hàng</th>
                  <th>Ngày đi</th>
                  <th>Số người</th>
                  <th>Tổng tiền</th>
                  <th>Thanh toán</th>
                  <th>Trạng thái</th>
                  <th>Ngày đặt</th>
                  <th>Thao tác</th>
                </tr>
              </thead>
              <tbody id="bookings-table-body">
                <tr>
                  <td colspan="10" class="loading-row">Đang tải dữ liệu...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- Customers Management Section -->
        <section class="content-section" id="customers-section">
          <div class="section-header">
            <h2>Quản lý Khách hàng</h2>
          </div>

          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Họ tên</th>
                  <th>Email</th>
                  <th>Số điện thoại</th>
                  <th>Địa chỉ</th>
                  <th>Số tour đã đặt</th>
                  <th>Tổng chi tiêu</th>
                  <th>Ngày đăng ký</th>
                  <th>Thao tác</th>
                </tr>
              </thead>
              <tbody id="customers-table-body">
                <tr>
                  <td colspan="9" class="loading-row">Đang tải dữ liệu...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
        <!-- Thêm section này sau section Quản lý Khách hàng -->
        <section class="content-section" id="hotels-section">
          <div class="section-header">
            <h2>Quản lý Đặt Phòng</h2>
            <div class="header-actions">
              <button class="btn btn-secondary" id="export-bookings">
                <i class="fas fa-download"></i> Xuất Excel
              </button>
              <button class="btn btn-primary" id="add-hotel-booking-btn">
                <i class="fas fa-plus"></i> Thêm đặt phòng
              </button>
            </div>
          </div>

          <div class="filters">
            <div class="filter-group">
              <input
                type="text"
                id="hotel-booking-search"
                placeholder="Tìm theo mã đặt, tên khách..."
              />
            </div>
            <div class="filter-group">
              <select id="hotel-booking-status-filter">
                <option value="">Tất cả trạng thái</option>
                <option value="pending">Chờ xác nhận</option>
                <option value="confirmed">Đã xác nhận</option>
                <option value="checked_in">Đã nhận phòng</option>
                <option value="checked_out">Đã trả phòng</option>
                <option value="cancelled">Đã hủy</option>
              </select>
            </div>
            <div class="filter-group">
              <input
                type="date"
                id="hotel-checkin-filter"
                placeholder="Ngày nhận phòng"
              />
            </div>
            <button class="btn btn-secondary" id="apply-hotel-filters">
              Lọc
            </button>
            <button class="btn btn-outline" id="reset-hotel-filters">
              Xóa lọc
            </button>
          </div>

          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Mã đặt</th>
                  <th>Khách sạn</th>
                  <th>Khách hàng</th>
                  <th>Loại phòng</th>
                  <th>Ngày nhận</th>
                  <th>Ngày trả</th>
                  <th>Số đêm</th>
                  <th>Số phòng</th>
                  <th>Số người</th>
                  <th>Tổng tiền</th>
                  <th>Trạng thái</th>
                  <th>Ngày đặt</th>
                  <th>Thao tác</th>
                </tr>
              </thead>
              <tbody id="hotel-bookings-table-body">
                <tr>
                  <td colspan="13" class="loading-row">Đang tải dữ liệu...</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="pagination" id="hotel-bookings-pagination">
            <!-- Pagination will be loaded here -->
          </div>
        </section>
        <!-- Tour Modal -->
        <div class="modal" id="tour-modal">
          <div class="modal-content large">
            <div class="modal-header">
              <h3 id="modal-title">Thêm tour mới</h3>
              <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
              <form id="tour-form">
                <input type="hidden" id="tour-id" />

                <div class="form-row">
                  <div class="form-group">
                    <label for="tour-name">Tên tour *</label>
                    <input type="text" id="tour-name" required />
                  </div>
                  <div class="form-group">
                    <label for="tour-slug">Slug</label>
                    <input type="text" id="tour-slug" />
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label for="tour-destination">Điểm đến *</label>
                    <input type="text" id="tour-destination" required />
                  </div>
                  <div class="form-group">
                    <label for="tour-departure">Nơi khởi hành</label>
                    <input type="text" id="tour-departure" />
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label for="tour-duration-days">Số ngày *</label>
                    <input
                      type="number"
                      id="tour-duration-days"
                      required
                      min="1"
                    />
                  </div>
                  <div class="form-group">
                    <label for="tour-duration-nights">Số đêm</label>
                    <input type="number" id="tour-duration-nights" min="0" />
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label for="tour-price-adult">Giá người lớn (VNĐ) *</label>
                    <input
                      type="number"
                      id="tour-price-adult"
                      required
                      min="0"
                    />
                  </div>
                  <div class="form-group">
                    <label for="tour-price-child">Giá trẻ em</label>
                    <input type="number" id="tour-price-child" min="0" />
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label for="tour-discount">Giảm giá (%)</label>
                    <input type="number" id="tour-discount" min="0" max="100" />
                  </div>
                  <div class="form-group">
                    <label for="tour-slots">Số chỗ còn nhận *</label>
                    <input type="number" id="tour-slots" required min="0" />
                  </div>
                </div>

                <div class="form-group">
                  <label for="tour-featured-image">URL hình ảnh chính</label>
                  <input type="text" id="tour-featured-image" />
                </div>

                <div class="form-group">
                  <label for="tour-short-desc">Mô tả ngắn *</label>
                  <textarea id="tour-short-desc" rows="3" required></textarea>
                </div>

                <div class="form-group">
                  <label for="tour-full-desc">Mô tả chi tiết</label>
                  <textarea id="tour-full-desc" rows="5"></textarea>
                </div>

                <div class="form-group">
                  <label for="tour-status">Trạng thái</label>
                  <select id="tour-status">
                    <option value="active">Đang hoạt động</option>
                    <option value="inactive">Ngừng hoạt động</option>
                    <option value="sold_out">Hết chỗ</option>
                  </select>
                </div>

                <div class="form-actions">
                  <button type="button" class="btn btn-secondary close-modal">
                    Hủy
                  </button>
                  <button type="submit" class="btn btn-primary">
                    Lưu tour
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </main>
    </div>
    <!-- Thêm modal này sau modal Tour -->
    <div class="modal" id="hotel-booking-modal">
      <div class="modal-content large">
        <div class="modal-header">
          <h3 id="hotel-modal-title">Thêm đặt phòng mới</h3>
          <button class="close-modal">&times;</button>
        </div>
        <div class="modal-body">
          <form id="hotel-booking-form">
            <input type="hidden" id="hotel-booking-id" />

            <div class="form-row">
              <div class="form-group">
                <label for="hotel-name">Tên khách sạn *</label>
                <input type="text" id="hotel-name" required />
              </div>
              <div class="form-group">
                <label for="customer-name">Tên khách hàng *</label>
                <input type="text" id="customer-name" required />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="customer-phone">Số điện thoại *</label>
                <input type="tel" id="customer-phone" required />
              </div>
              <div class="form-group">
                <label for="customer-email">Email</label>
                <input type="email" id="customer-email" />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="room-type">Loại phòng *</label>
                <select id="room-type" required>
                  <option value="">Chọn loại phòng</option>
                  <option value="standard">Phòng Standard</option>
                  <option value="deluxe">Phòng Deluxe</option>
                  <option value="suite">Phòng Suite</option>
                  <option value="family">Phòng Gia đình</option>
                  <option value="villa">Villa</option>
                </select>
              </div>
              <div class="form-group">
                <label for="room-price">Giá phòng/đêm (VNĐ) *</label>
                <input type="number" id="room-price" required min="0" />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="checkin-date">Ngày nhận phòng *</label>
                <input type="date" id="checkin-date" required />
              </div>
              <div class="form-group">
                <label for="checkout-date">Ngày trả phòng *</label>
                <input type="date" id="checkout-date" required />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="number-of-rooms">Số phòng *</label>
                <input
                  type="number"
                  id="number-of-rooms"
                  required
                  min="1"
                  value="1"
                />
              </div>
              <div class="form-group">
                <label for="number-of-guests">Số người *</label>
                <input
                  type="number"
                  id="number-of-guests"
                  required
                  min="1"
                  value="2"
                />
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="number-of-nights">Số đêm</label>
                <input type="number" id="number-of-nights" readonly />
              </div>
              <div class="form-group">
                <label for="total-amount">Tổng tiền (VNĐ)</label>
                <input type="text" id="total-amount" readonly />
              </div>
            </div>

            <div class="form-group">
              <label for="special-requests">Yêu cầu đặc biệt</label>
              <textarea
                id="special-requests"
                rows="3"
                placeholder="Yêu cầu về giường, thức ăn, dịch vụ..."
              ></textarea>
            </div>

            <div class="form-group">
              <label for="payment-status">Trạng thái thanh toán</label>
              <select id="payment-status">
                <option value="pending">Chưa thanh toán</option>
                <option value="partial">Thanh toán một phần</option>
                <option value="paid">Đã thanh toán</option>
                <option value="refunded">Đã hoàn tiền</option>
              </select>
            </div>

            <div class="form-group">
              <label for="booking-status">Trạng thái đặt phòng</label>
              <select id="booking-status">
                <option value="pending">Chờ xác nhận</option>
                <option value="confirmed">Đã xác nhận</option>
                <option value="checked_in">Đã nhận phòng</option>
                <option value="checked_out">Đã trả phòng</option>
                <option value="cancelled">Đã hủy</option>
              </select>
            </div>

            <div class="form-actions">
              <button type="button" class="btn btn-secondary close-modal">
                Hủy
              </button>
              <button type="submit" class="btn btn-primary">
                Lưu đặt phòng
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../assets/js/admin.js"></script>
    <script>
      // Base URL cho API
      const API_BASE_URL = "http://localhost/ivivu-clone/backend/api";

      // Khởi tạo admin
      document.addEventListener("DOMContentLoaded", function () {
        initAdmin();
        loadDashboardData();
      });

      function initAdmin() {
        // Navigation
        const menuItems = document.querySelectorAll(".sidebar-menu li");
        menuItems.forEach((item) => {
          item.addEventListener("click", function () {
            menuItems.forEach((i) => i.classList.remove("active"));
            this.classList.add("active");

            const section = this.getAttribute("data-section");
            showSection(section);
          });
        });

        // Modals
        document.querySelectorAll(".close-modal").forEach((btn) => {
          btn.addEventListener("click", closeAllModals);
        });

        document
          .getElementById("add-tour-btn")
          .addEventListener("click", function () {
            openTourModal();
          });

        // Tour form
        document
          .getElementById("tour-form")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            saveTour();
          });

        // Auto generate slug
        document
          .getElementById("tour-name")
          .addEventListener("input", function () {
            const name = this.value;
            const slug = name
              .toLowerCase()
              .replace(/[^a-z0-9]+/g, "-")
              .replace(/(^-|-$)/g, "");
            document.getElementById("tour-slug").value = slug;
          });
      }

      function showSection(section) {
        // Hide all sections
        document.querySelectorAll(".content-section").forEach((sec) => {
          sec.classList.remove("active");
        });

        // Show selected section
        document.getElementById(`${section}-section`).classList.add("active");

        // Update page title
        const titles = {
          dashboard: "Dashboard",
          tours: "Quản lý Tour",
          bookings: "Quản lý Đặt Tour",
          customers: "Quản lý Khách hàng",
        };

        document.getElementById("page-title").textContent =
          titles[section] || section;

        // Load section data
        switch (section) {
          case "dashboard":
            loadDashboardData();
            break;
          case "tours":
            loadTours();
            break;
          case "bookings":
            loadBookings();
            break;
          case "customers":
            loadCustomers();
            break;
        }
      }

      async function loadDashboardData() {
        try {
          // Load stats
          const response = await fetch(`${API_BASE_URL}/dashboard`);
          const data = await response.json();

          if (data.success) {
            document.getElementById("total-tours").textContent =
              data.data.total_tours || 0;
            document.getElementById("total-bookings").textContent =
              data.data.today_bookings || 0;
            document.getElementById("total-customers").textContent =
              data.data.total_customers || 0;
            document.getElementById("total-revenue").textContent =
              formatCurrency(data.data.monthly_revenue || 0);
          }

          // Load charts
          renderCharts(data.data?.charts || {});

          // Load activities
          loadRecentActivities();
        } catch (error) {
          console.error("Error loading dashboard:", error);
          showToast("Lỗi tải dữ liệu dashboard", "error");
        }
      }

      async function loadTours() {
        try {
          const response = await fetch(`${API_BASE_URL}/tours`);
          const data = await response.json();

          if (data.success) {
            renderToursTable(data.data);
          }
        } catch (error) {
          console.error("Error loading tours:", error);
          showToast("Lỗi tải danh sách tour", "error");
        }
      }

      function renderToursTable(tours) {
        const tbody = document.getElementById("tours-table-body");

        if (!tours || tours.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="10" class="no-data">Không có tour nào</td></tr>';
          return;
        }

        let html = "";

        tours.forEach((tour) => {
          const finalPrice =
            tour.price_adult * (1 - tour.discount_percent / 100);
          const statusClass = `status-${tour.status}`;
          const statusText =
            {
              active: "Hoạt động",
              inactive: "Ngừng HĐ",
              sold_out: "Hết chỗ",
            }[tour.status] || tour.status;

          html += `
                    <tr>
                        <td>${tour.id}</td>
                        <td>
                            <img src="${
                              tour.featured_image ||
                              "https://via.placeholder.com/50"
                            }" 
                                 alt="${tour.name}" class="table-image">
                        </td>
                        <td>${tour.name}</td>
                        <td>${tour.destination}</td>
                        <td>${formatCurrency(finalPrice)}</td>
                        <td>${tour.discount_percent}%</td>
                        <td>${tour.available_slots}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${formatDate(tour.created_at)}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn edit-btn" onclick="editTour(${
                                  tour.id
                                })">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn delete-btn" onclick="deleteTour(${
                                  tour.id
                                })">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
        });

        tbody.innerHTML = html;
      }

      function openTourModal(tourId = null) {
        const modal = document.getElementById("tour-modal");
        const title = document.getElementById("modal-title");
        const form = document.getElementById("tour-form");

        if (tourId) {
          title.textContent = "Chỉnh sửa tour";
          loadTourData(tourId);
        } else {
          title.textContent = "Thêm tour mới";
          form.reset();
          document.getElementById("tour-id").value = "";
        }

        modal.classList.add("active");
      }

      async function loadTourData(tourId) {
        try {
          const response = await fetch(`${API_BASE_URL}/tours/${tourId}`);
          const data = await response.json();

          if (data.success) {
            const tour = data.data;
            document.getElementById("tour-id").value = tour.id;
            document.getElementById("tour-name").value = tour.name;
            document.getElementById("tour-slug").value = tour.slug;
            document.getElementById("tour-destination").value =
              tour.destination;
            document.getElementById("tour-departure").value =
              tour.departure_location;
            document.getElementById("tour-duration-days").value =
              tour.duration_days;
            document.getElementById("tour-duration-nights").value =
              tour.duration_nights;
            document.getElementById("tour-price-adult").value =
              tour.price_adult;
            document.getElementById("tour-price-child").value =
              tour.price_child || 0;
            document.getElementById("tour-discount").value =
              tour.discount_percent;
            document.getElementById("tour-slots").value = tour.available_slots;
            document.getElementById("tour-featured-image").value =
              tour.featured_image || "";
            document.getElementById("tour-short-desc").value =
              tour.short_description;
            document.getElementById("tour-full-desc").value = tour.description;
            document.getElementById("tour-status").value = tour.status;
          }
        } catch (error) {
          console.error("Error loading tour data:", error);
          showToast("Lỗi tải dữ liệu tour", "error");
        }
      }

      async function saveTour() {
        const tourId = document.getElementById("tour-id").value;
        const isEdit = !!tourId;

        const tourData = {
          name: document.getElementById("tour-name").value,
          slug: document.getElementById("tour-slug").value,
          destination: document.getElementById("tour-destination").value,
          departure_location: document.getElementById("tour-departure").value,
          duration_days: parseInt(
            document.getElementById("tour-duration-days").value
          ),
          duration_nights: parseInt(
            document.getElementById("tour-duration-nights").value
          ),
          price_adult: parseFloat(
            document.getElementById("tour-price-adult").value
          ),
          price_child: parseFloat(
            document.getElementById("tour-price-child").value
          ),
          discount_percent: parseInt(
            document.getElementById("tour-discount").value
          ),
          available_slots: parseInt(
            document.getElementById("tour-slots").value
          ),
          featured_image: document.getElementById("tour-featured-image").value,
          short_description: document.getElementById("tour-short-desc").value,
          description: document.getElementById("tour-full-desc").value,
          status: document.getElementById("tour-status").value,
        };

        try {
          const url = `${API_BASE_URL}/tours${isEdit ? "/" + tourId : ""}`;
          const method = isEdit ? "PUT" : "POST";

          const response = await fetch(url, {
            method: method,
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(tourData),
          });

          const result = await response.json();

          if (result.success) {
            showToast(
              isEdit ? "Cập nhật tour thành công" : "Thêm tour thành công",
              "success"
            );
            closeAllModals();
            loadTours();

            if (!isEdit) {
              loadDashboardData(); // Refresh dashboard stats
            }
          } else {
            showToast(result.message || "Có lỗi xảy ra", "error");
          }
        } catch (error) {
          console.error("Error saving tour:", error);
          showToast("Lỗi lưu tour", "error");
        }
      }

      async function deleteTour(tourId) {
        if (!confirm("Bạn có chắc chắn muốn xóa tour này?")) {
          return;
        }

        try {
          const response = await fetch(`${API_BASE_URL}/tours/${tourId}`, {
            method: "DELETE",
          });

          const result = await response.json();

          if (result.success) {
            showToast("Xóa tour thành công", "success");
            loadTours();
            loadDashboardData();
          } else {
            showToast(result.message || "Có lỗi xảy ra", "error");
          }
        } catch (error) {
          console.error("Error deleting tour:", error);
          showToast("Lỗi xóa tour", "error");
        }
      }

      function editTour(tourId) {
        openTourModal(tourId);
      }

      // Utility functions
      function formatCurrency(amount) {
        return new Intl.NumberFormat("vi-VN", {
          style: "currency",
          currency: "VND",
        }).format(amount);
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("vi-VN");
      }

      function showToast(message, type = "success") {
        const toast = document.getElementById("toast");
        toast.textContent = message;
        toast.className = `toast ${type}`;
        toast.classList.add("show");

        setTimeout(() => {
          toast.classList.remove("show");
        }, 3000);
      }

      function closeAllModals() {
        document.querySelectorAll(".modal").forEach((modal) => {
          modal.classList.remove("active");
        });
      }

      function renderCharts(chartData) {
        // Revenue Chart
        const revenueCtx = document
          .getElementById("revenueChart")
          .getContext("2d");
        new Chart(revenueCtx, {
          type: "line",
          data: {
            labels: chartData.months || [
              "Tháng 1",
              "Tháng 2",
              "Tháng 3",
              "Tháng 4",
              "Tháng 5",
              "Tháng 6",
            ],
            datasets: [
              {
                label: "Doanh thu (triệu VNĐ)",
                data: chartData.revenue || [12, 19, 15, 25, 22, 30],
                borderColor: "#3498db",
                backgroundColor: "rgba(52, 152, 219, 0.1)",
                borderWidth: 2,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                display: true,
                position: "top",
              },
            },
          },
        });

        // Popular Tours Chart
        const toursCtx = document
          .getElementById("popularToursChart")
          .getContext("2d");
        new Chart(toursCtx, {
          type: "bar",
          data: {
            labels: chartData.popular_tours_names || [
              "Tour A",
              "Tour B",
              "Tour C",
              "Tour D",
              "Tour E",
            ],
            datasets: [
              {
                label: "Số lượt đặt",
                data: chartData.popular_tours_counts || [65, 59, 80, 81, 56],
                backgroundColor: [
                  "rgba(52, 152, 219, 0.7)",
                  "rgba(46, 204, 113, 0.7)",
                  "rgba(155, 89, 182, 0.7)",
                  "rgba(241, 196, 15, 0.7)",
                  "rgba(230, 126, 34, 0.7)",
                ],
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                display: false,
              },
            },
          },
        });
      }

      async function loadRecentActivities() {
        // Simulate loading activities
        const activities = [
          {
            type: "booking",
            message: "Đặt tour Đà Lạt mới",
            time: "5 phút trước",
          },
          {
            type: "tour",
            message: "Tour Phú Quốc đã được cập nhật",
            time: "1 giờ trước",
          },
          {
            type: "customer",
            message: "Khách hàng mới đăng ký",
            time: "2 giờ trước",
          },
        ];

        const container = document.getElementById("recent-activities");
        let html = "";

        activities.forEach((activity) => {
          const icon =
            {
              booking: "fas fa-calendar-plus",
              tour: "fas fa-map-marked-alt",
              customer: "fas fa-user-plus",
            }[activity.type] || "fas fa-info-circle";

          html += `
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="${icon}"></i>
                        </div>
                        <div class="activity-info">
                            <p>${activity.message}</p>
                            <span class="activity-time">${activity.time}</span>
                        </div>
                    </div>
                `;
        });

        container.innerHTML = html;
      }
    </script>
  </body>
</html>
