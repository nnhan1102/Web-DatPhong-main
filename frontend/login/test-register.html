<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test API ƒêƒÉng K√Ω</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: Arial, sans-serif;
        background: #f5f5f5;
        padding: 20px;
        line-height: 1.6;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 10px;
        padding: 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #333;
        margin-bottom: 20px;
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
      }

      .section {
        margin-bottom: 30px;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background: #fafafa;
      }

      h2 {
        color: #555;
        margin-bottom: 15px;
      }

      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #333;
      }

      input[type="text"],
      input[type="email"],
      input[type="password"],
      input[type="tel"] {
        width: 100%;
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 16px;
      }

      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        margin-right: 10px;
        margin-bottom: 10px;
      }

      button:hover {
        background: #0056b3;
      }

      button.secondary {
        background: #6c757d;
      }

      button.secondary:hover {
        background: #545b62;
      }

      .result {
        margin-top: 20px;
        padding: 15px;
        border-radius: 5px;
        font-family: monospace;
        white-space: pre-wrap;
        word-wrap: break-word;
        max-height: 400px;
        overflow-y: auto;
      }

      .success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      .api-url {
        background: #e9ecef;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 15px;
        font-family: monospace;
        font-size: 14px;
        word-break: break-all;
      }

      .test-cases {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 10px;
        margin-top: 15px;
      }

      .test-case {
        padding: 10px;
        background: #fff;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .test-case:hover {
        background: #007bff;
        color: white;
        border-color: #007bff;
      }

      .status {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 3px;
        font-size: 12px;
        font-weight: bold;
        margin-left: 10px;
      }

      .status.success {
        background: #28a745;
        color: white;
      }

      .status.error {
        background: #dc3545;
        color: white;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîß Test API ƒêƒÉng K√Ω Opulent Hotel</h1>

      <div class="section">
        <h2>1. Ki·ªÉm tra k·∫øt n·ªëi API</h2>
        <p>API URL hi·ªán t·∫°i:</p>
        <div class="api-url" id="apiUrl">ƒêang t·∫£i...</div>
        <button onclick="testConnection()">Ki·ªÉm tra k·∫øt n·ªëi</button>
        <div id="connectionResult" class="result"></div>
      </div>

      <div class="section">
        <h2>2. Test ƒëƒÉng k√Ω user m·ªõi</h2>
        <div class="test-cases">
          <div class="test-case" onclick="fillTestData('test1')">
            User th∆∞·ªùng
            <span class="status success" id="status1"></span>
          </div>
          <div class="test-case" onclick="fillTestData('test2')">
            User VIP
            <span class="status success" id="status2"></span>
          </div>
          <div class="test-case" onclick="fillTestData('test3')">
            Thi·∫øu th√¥ng tin
            <span class="status error" id="status3"></span>
          </div>
          <div class="test-case" onclick="fillTestData('test4')">
            Email t·ªìn t·∫°i
            <span class="status error" id="status4"></span>
          </div>
        </div>

        <form id="testForm">
          <label>T√™n ƒëƒÉng nh·∫≠p:</label>
          <input
            type="text"
            id="testUsername"
            placeholder="username"
            required
          />

          <label>Email:</label>
          <input
            type="email"
            id="testEmail"
            placeholder="email@example.com"
            required
          />

          <label>M·∫≠t kh·∫©u:</label>
          <input
            type="password"
            id="testPassword"
            placeholder="m·∫≠t kh·∫©u"
            required
          />

          <label>H·ªç v√† t√™n:</label>
          <input
            type="text"
            id="testFullName"
            placeholder="Nguy·ªÖn VƒÉn A"
            required
          />

          <label>S·ªë ƒëi·ªán tho·∫°i:</label>
          <input type="tel" id="testPhone" placeholder="0912345678" required />

          <label>ƒê·ªãa ch·ªâ:</label>
          <input
            type="text"
            id="testAddress"
            placeholder="S·ªë nh√†, ƒë∆∞·ªùng, th√†nh ph·ªë"
          />

          <button type="button" onclick="testRegister()">Test ƒêƒÉng K√Ω</button>
          <button type="button" class="secondary" onclick="clearForm()">
            Clear Form
          </button>
        </form>

        <div id="registerResult" class="result"></div>
      </div>

      <div class="section">
        <h2>3. Test ƒëƒÉng nh·∫≠p</h2>
        <label>Email/Username:</label>
        <input
          type="text"
          id="loginIdentifier"
          placeholder="email ho·∫∑c username"
        />

        <label>M·∫≠t kh·∫©u:</label>
        <input type="password" id="loginPassword" placeholder="m·∫≠t kh·∫©u" />

        <button onclick="testLogin()">Test ƒêƒÉng Nh·∫≠p</button>
        <button class="secondary" onclick="testLogout()">Test ƒêƒÉng Xu·∫•t</button>
        <button class="secondary" onclick="testCurrentUser()">
          Test L·∫•y User Hi·ªán T·∫°i
        </button>

        <div id="loginResult" class="result"></div>
      </div>

      <div class="section">
        <h2>4. Debug th√¥ng tin</h2>
        <button onclick="debugLocalStorage()">Ki·ªÉm tra LocalStorage</button>
        <button onclick="debugSession()">Ki·ªÉm tra Session</button>
        <button onclick="debugCookies()">Ki·ªÉm tra Cookies</button>
        <button class="secondary" onclick="clearAllData()">
          X√≥a t·∫•t c·∫£ d·ªØ li·ªáu
        </button>

        <div id="debugResult" class="result"></div>
      </div>

      <div class="section info">
        <h2>üìã H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</h2>
        <p>
          <strong>B∆∞·ªõc 1:</strong> Click "Ki·ªÉm tra k·∫øt n·ªëi" ƒë·ªÉ ƒë·∫£m b·∫£o API ho·∫°t
          ƒë·ªông
        </p>
        <p>
          <strong>B∆∞·ªõc 2:</strong> Ch·ªçn test case ho·∫∑c ƒëi·ªÅn th√¥ng tin form,
          click "Test ƒêƒÉng K√Ω"
        </p>
        <p><strong>B∆∞·ªõc 3:</strong> Ki·ªÉm tra k·∫øt qu·∫£ tr·∫£ v·ªÅ trong √¥ Result</p>
        <p><strong>L·ªói 500 Internal Server Error:</strong> C√≥ th·ªÉ do:</p>
        <ul>
          <li>Database connection l·ªói</li>
          <li>File PHP c√≥ syntax error</li>
          <li>Table kh√¥ng t·ªìn t·∫°i</li>
          <li>Server config sai</li>
        </ul>
        <p>
          <strong>L·ªói "Unexpected token '<'":</strong> Server tr·∫£ v·ªÅ HTML thay
          v√¨ JSON
        </p>
      </div>
    </div>

    <script>
      // C·∫•u h√¨nh API URL
      const API_BASE_URL = "../../backend/api";
      let testHistory = {};

      // Hi·ªÉn th·ªã API URL
      document.getElementById("apiUrl").textContent = API_BASE_URL;

      // Test k·∫øt n·ªëi
      async function testConnection() {
        const resultDiv = document.getElementById("connectionResult");
        resultDiv.className = "result info";
        resultDiv.textContent = "ƒêang ki·ªÉm tra k·∫øt n·ªëi...";

        try {
          const response = await fetch(`${API_BASE_URL}/test-connection.php`);
          const text = await response.text();

          try {
            const data = JSON.parse(text);
            resultDiv.className = "result success";
            resultDiv.textContent = JSON.stringify(data, null, 2);

            // Update status indicators
            document.getElementById("status1").textContent = "‚úì";
            document.getElementById("status2").textContent = "‚úì";
            document.getElementById("status3").textContent = "‚úì";
            document.getElementById("status4").textContent = "‚úì";
          } catch (e) {
            resultDiv.className = "result error";
            resultDiv.textContent =
              "L·ªói: Server tr·∫£ v·ªÅ kh√¥ng ph·∫£i JSON\n" +
              "Response: " +
              text.substring(0, 500) +
              "\n\nC√≥ th·ªÉ server ƒëang hi·ªÉn th·ªã l·ªói PHP. Ki·ªÉm tra file PHP c√≥ syntax error kh√¥ng.";
          }
        } catch (error) {
          resultDiv.className = "result error";
          resultDiv.textContent =
            "L·ªói k·∫øt n·ªëi: " +
            error.message +
            "\n\nKi·ªÉm tra:\n" +
            "1. Server c√≥ ƒëang ch·∫°y kh√¥ng?\n" +
            "2. ƒê∆∞·ªùng d·∫´n API c√≥ ƒë√∫ng kh√¥ng?\n" +
            "3. CORS c√≥ ƒë∆∞·ª£c c·∫•u h√¨nh kh√¥ng?";
        }
      }

      // ƒêi·ªÅn d·ªØ li·ªáu test
      function fillTestData(testType) {
        const now = Date.now();
        const testData = {
          test1: {
            username: `testuser_${now}`,
            email: `test${now}@example.com`,
            password: "123456",
            full_name: "Nguy·ªÖn VƒÉn Test",
            phone: "0912345678",
            address: "123 ƒê∆∞·ªùng Test, TP Test",
          },
          test2: {
            username: `vipuser_${now}`,
            email: `vip${now}@example.com`,
            password: "vip123",
            full_name: "Tr·∫ßn Th·ªã VIP",
            phone: "0987654321",
            address: "456 VIP Street, VIP City",
          },
          test3: {
            username: "",
            email: "",
            password: "",
            full_name: "",
            phone: "",
            address: "",
          },
          test4: {
            username: "admin",
            email: "admin@opulent.com",
            password: "123456",
            full_name: "Admin Test",
            phone: "0909090909",
            address: "Test Address",
          },
        };

        const data = testData[testType] || testData.test1;

        document.getElementById("testUsername").value = data.username;
        document.getElementById("testEmail").value = data.email;
        document.getElementById("testPassword").value = data.password;
        document.getElementById("testFullName").value = data.full_name;
        document.getElementById("testPhone").value = data.phone;
        document.getElementById("testAddress").value = data.address;
      }

      // Test ƒëƒÉng k√Ω
      async function testRegister() {
        const resultDiv = document.getElementById("registerResult");
        resultDiv.className = "result info";
        resultDiv.textContent = "ƒêang g·ª≠i request ƒëƒÉng k√Ω...";

        const formData = {
          username: document.getElementById("testUsername").value,
          email: document.getElementById("testEmail").value,
          password: document.getElementById("testPassword").value,
          full_name: document.getElementById("testFullName").value,
          phone: document.getElementById("testPhone").value,
          address: document.getElementById("testAddress").value,
        };

        // L∆∞u l·∫°i test case
        const testId = Date.now();
        testHistory[testId] = formData;

        try {
          const response = await fetch(`${API_BASE_URL}/auth/register`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(formData),
          });

          const responseText = await response.text();

          // Hi·ªÉn th·ªã raw response
          console.log("Raw response:", responseText);

          try {
            const data = JSON.parse(responseText);

            if (data.success) {
              resultDiv.className = "result success";
              resultDiv.textContent =
                "‚úÖ ƒêƒÇNG K√ù TH√ÄNH C√îNG!\n\n" + JSON.stringify(data, null, 2);

              // L∆∞u user v√†o localStorage ƒë·ªÉ test login
              localStorage.setItem(
                "test_user",
                JSON.stringify({
                  ...data.data.user,
                  testId: testId,
                  testPassword: formData.password,
                })
              );
            } else {
              resultDiv.className = "result error";
              resultDiv.textContent =
                "‚ùå ƒêƒÇNG K√ù TH·∫§T B·∫†I\n\n" + JSON.stringify(data, null, 2);
            }
          } catch (jsonError) {
            // Server tr·∫£ v·ªÅ HTML/Text thay v√¨ JSON
            resultDiv.className = "result error";
            resultDiv.textContent =
              "‚ö†Ô∏è L·ªñI: Server tr·∫£ v·ªÅ kh√¥ng ph·∫£i JSON\n\n" +
              "Status: " +
              response.status +
              " " +
              response.statusText +
              "\n" +
              "Content-Type: " +
              response.headers.get("content-type") +
              "\n\n" +
              "Response (500 k√Ω t·ª± ƒë·∫ßu):\n" +
              responseText.substring(0, 500) +
              "\n\n" +
              "C√≥ th·ªÉ PHP ƒëang hi·ªÉn th·ªã l·ªói. Ki·ªÉm tra:";

            // Th√™m g·ª£i √Ω debug
            resultDiv.textContent += "\n\n=== DEBUG HINTS ===\n";
            resultDiv.textContent += "1. Ki·ªÉm tra error_log c·ªßa PHP\n";
            resultDiv.textContent +=
              "2. Ki·ªÉm tra file AuthController.php c√≥ syntax error kh√¥ng\n";
            resultDiv.textContent +=
              "3. Ki·ªÉm tra file User.php c√≥ syntax error kh√¥ng\n";
            resultDiv.textContent += "4. Ki·ªÉm tra k·∫øt n·ªëi database\n";
            resultDiv.textContent += "5. Ki·ªÉm tra table users c√≥ t·ªìn t·∫°i kh√¥ng";
          }
        } catch (error) {
          resultDiv.className = "result error";
          resultDiv.textContent =
            "üö® L·ªñI K·∫æT N·ªêI:\n\n" +
            error.message +
            "\n\n" +
            "Ki·ªÉm tra:\n" +
            "1. CORS configuration\n" +
            "2. Network connection\n" +
            "3. Server status\n" +
            "4. URL endpoint: " +
            `${API_BASE_URL}/auth/register`;
        }
      }

      // Test ƒëƒÉng nh·∫≠p
      async function testLogin() {
        const resultDiv = document.getElementById("loginResult");
        const identifier = document.getElementById("loginIdentifier").value;
        const password = document.getElementById("loginPassword").value;

        if (!identifier || !password) {
          resultDiv.className = "result error";
          resultDiv.textContent = "Vui l√≤ng nh·∫≠p identifier v√† password";
          return;
        }

        resultDiv.className = "result info";
        resultDiv.textContent = "ƒêang ƒëƒÉng nh·∫≠p...";

        try {
          const response = await fetch(`${API_BASE_URL}/auth/login`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              identifier: identifier,
              password: password,
            }),
            credentials: "include",
          });

          const responseText = await response.text();

          try {
            const data = JSON.parse(responseText);

            if (data.success) {
              resultDiv.className = "result success";
              resultDiv.textContent =
                "‚úÖ ƒêƒÇNG NH·∫¨P TH√ÄNH C√îNG!\n\n" + JSON.stringify(data, null, 2);

              // L∆∞u session
              localStorage.setItem(
                "opulent_user",
                JSON.stringify({
                  ...data.data.user,
                  isLoggedIn: true,
                  session_id: data.data.session_id,
                })
              );
            } else {
              resultDiv.className = "result error";
              resultDiv.textContent =
                "‚ùå ƒêƒÇNG NH·∫¨P TH·∫§T B·∫†I\n\n" + JSON.stringify(data, null, 2);
            }
          } catch (jsonError) {
            resultDiv.className = "result error";
            resultDiv.textContent =
              "‚ö†Ô∏è L·ªñI JSON: " +
              jsonError.message +
              "\n\n" +
              "Response:\n" +
              responseText.substring(0, 500);
          }
        } catch (error) {
          resultDiv.className = "result error";
          resultDiv.textContent = "üö® L·ªñI K·∫æT N·ªêI: " + error.message;
        }
      }

      // Test logout
      async function testLogout() {
        const resultDiv = document.getElementById("loginResult");
        resultDiv.className = "result info";
        resultDiv.textContent = "ƒêang ƒëƒÉng xu·∫•t...";

        try {
          const response = await fetch(`${API_BASE_URL}/auth/logout`, {
            method: "POST",
            credentials: "include",
          });

          const responseText = await response.text();

          try {
            const data = JSON.parse(responseText);
            resultDiv.className = "result success";
            resultDiv.textContent =
              "‚úÖ ƒêƒÇNG XU·∫§T TH√ÄNH C√îNG!\n\n" + JSON.stringify(data, null, 2);

            // X√≥a localStorage
            localStorage.removeItem("opulent_user");
          } catch (jsonError) {
            resultDiv.className = "result error";
            resultDiv.textContent = "‚ö†Ô∏è L·ªñI JSON: " + jsonError.message;
          }
        } catch (error) {
          resultDiv.className = "result error";
          resultDiv.textContent = "üö® L·ªñI K·∫æT N·ªêI: " + error.message;
        }
      }

      // Test current user
      async function testCurrentUser() {
        const resultDiv = document.getElementById("loginResult");
        resultDiv.className = "result info";
        resultDiv.textContent = "ƒêang l·∫•y th√¥ng tin user...";

        try {
          const response = await fetch(`${API_BASE_URL}/auth/me`, {
            method: "GET",
            credentials: "include",
          });

          const responseText = await response.text();

          try {
            const data = JSON.parse(responseText);
            resultDiv.className = "result success";
            resultDiv.textContent = JSON.stringify(data, null, 2);
          } catch (jsonError) {
            resultDiv.className = "result error";
            resultDiv.textContent =
              "‚ö†Ô∏è L·ªñI JSON: " +
              jsonError.message +
              "\n\n" +
              "Response:\n" +
              responseText.substring(0, 500);
          }
        } catch (error) {
          resultDiv.className = "result error";
          resultDiv.textContent = "üö® L·ªñI K·∫æT N·ªêI: " + error.message;
        }
      }

      // Debug localStorage
      function debugLocalStorage() {
        const resultDiv = document.getElementById("debugResult");
        resultDiv.className = "result info";

        let debugInfo = "=== LOCALSTORAGE ===\n\n";

        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          let value = localStorage.getItem(key);

          try {
            // Th·ª≠ parse JSON
            const parsed = JSON.parse(value);
            value = JSON.stringify(parsed, null, 2);
          } catch (e) {
            // Gi·ªØ nguy√™n string
          }

          debugInfo += `[${key}]:\n${value}\n\n`;
        }

        debugInfo += `T·ªïng: ${localStorage.length} items\n`;
        debugInfo += `Dung l∆∞·ª£ng ∆∞·ªõc t√≠nh: ${
          JSON.stringify(localStorage).length
        } bytes`;

        resultDiv.textContent = debugInfo;
      }

      // Debug session
      function debugSession() {
        const resultDiv = document.getElementById("debugResult");
        resultDiv.className = "result info";

        let debugInfo = "=== SESSION & COOKIES ===\n\n";

        // Cookies
        debugInfo += "Cookies:\n";
        debugInfo += document.cookie || "Kh√¥ng c√≥ cookies\n";
        debugInfo += "\n";

        // Session storage
        debugInfo += "Session Storage:\n";
        for (let i = 0; i < sessionStorage.length; i++) {
          const key = sessionStorage.key(i);
          debugInfo += `${key}: ${sessionStorage.getItem(key)}\n`;
        }

        if (sessionStorage.length === 0) {
          debugInfo += "Kh√¥ng c√≥ session storage\n";
        }

        resultDiv.textContent = debugInfo;
      }

      // Debug cookies
      function debugCookies() {
        const resultDiv = document.getElementById("debugResult");
        resultDiv.className = "result info";

        const cookies = document.cookie.split(";").map((cookie) => {
          const [name, value] = cookie.trim().split("=");
          return { name, value: value || "(empty)" };
        });

        let debugInfo = "=== COOKIES DETAIL ===\n\n";

        cookies.forEach((cookie) => {
          debugInfo += `üç™ ${cookie.name}: ${cookie.value}\n`;
        });

        debugInfo += `\nT·ªïng: ${cookies.length} cookies`;

        resultDiv.textContent = debugInfo;
      }

      // Clear form
      function clearForm() {
        document.getElementById("testForm").reset();
        document.getElementById("registerResult").textContent = "";
      }

      // Clear all data
      function clearAllData() {
        localStorage.clear();
        sessionStorage.clear();

        // X√≥a cookies (c·∫ßn set expiration date qu√° kh·ª©)
        document.cookie.split(";").forEach((cookie) => {
          const name = cookie.trim().split("=")[0];
          document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
        });

        const resultDiv = document.getElementById("debugResult");
        resultDiv.className = "result success";
        resultDiv.textContent =
          "‚úÖ ƒê√£ x√≥a t·∫•t c·∫£ d·ªØ li·ªáu (localStorage, sessionStorage, cookies)";
      }

      // Auto test connection khi load trang
      window.addEventListener("load", function () {
        setTimeout(testConnection, 500);
      });
    </script>
  </body>
</html>
